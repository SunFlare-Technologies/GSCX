# Simple i18n utility for GSCX GUI
# Supported languages: English (en), Spanish (es), Portuguese (pt)
from typing import Dict

_current_lang = 'en'

LANG_DISPLAY = {
    'en': 'English',
    'es': 'Español',
    'pt': 'Português',
}

# Translation catalog
# Keys are semantic identifiers used across the UI
_translations: Dict[str, Dict[str, str]] = {
    'en': {
        # General
        'general.language': 'Language',
        'general.save': 'Save Configuration',
        'general.warning': 'Warning',
        'general.error': 'Error',
        'general.info': 'Information',
        # Setup
        'setup.title': 'PS3 Console Setup',
        # Model
        'model.group': 'Console Model',
        'model.label': 'Model:',
        'model.placeholder': 'e.g., CECHA01, CECH-2001A, CECH-4001B',
        'model.validate': 'Validate',
        'model.hint': 'Enter a model to validate',
        # GPU
        'gpu.group': 'GPU (RSX) Configuration',
        'gpu.auto': 'Automatic assignment',
        'gpu.manual': 'Manual assignment',
        'gpu.label': 'GPU:',
        # Disc
        'disc.group': 'Disc Reader',
        'disc.use_physical': 'Use physical disc drive',
        # Virtual USB / Firmware
        'usb.group': 'Virtual USB (CFW/OFW)',
        'usb.firmware_label': 'Firmware (.PUP):',
        'usb.firmware_placeholder': 'Select firmware file',
        'usb.browse': 'Browse',
        'usb.none_selected': 'No firmware selected',
        'usb.folder_label': 'Virtual USB folder (optional):',
        'usb.folder_tooltip': 'If provided, the PUP will be copied as PS3UPDAT.PUP inside this folder.',
        'usb.open_folder': 'Open Folder',
        'usb.open_folder_tooltip': 'Opens the virtual USB folder in Explorer',
        'usb.dialog_title': 'Virtual USB',
        'usb.no_folder': 'No folder available yet. Provide a path or start Recovery with a PUP.',
        'usb.folder_not_exists': 'Folder does not exist: {target}',
        'usb.open_failed_title': 'Open Folder',
        'usb.open_failed': 'Failed to open folder: {error}',
        'usb.open_error': 'Error: {error}',
        # Storage and Memory
        'storage.group': 'Storage and Memory',
        'storage.memory_label': 'Emulator Memory (GB):',
        'storage.hdd_path_label': 'Virtual HDD path:',
        'storage.hdd_path_placeholder': 'e.g., C:/GSCX/storage/ps3_hdd.img',
        'storage.hdd_size_label': 'HDD size (GB):',
        'storage.hdd_allocate': 'Allocate HDD',
        'storage.hdd_dialog_title': 'Virtual HDD',
        'storage.hdd_need_path': 'Please enter the virtual HDD file path (.img/.vhd)',
        'storage.hdd_alloc_ok': 'HDD successfully allocated at:\n{final_path}',
        'storage.hdd_alloc_fail': 'Failed to allocate HDD: {error}',
        # Recovery
        'recovery.start': 'Start Recovery Mode',
        'recovery.warning_invalid_pup': 'The PUP file looks invalid. Fix it before continuing.',
        'recovery.error_title': 'Error',
        'recovery.error_start': 'Failed to start Recovery Mode: {message}',
        # File dialogs
        'file.select_firmware': 'Select firmware',
        'file.ps3_firmware_filter': 'PS3 Firmware (*.PUP)',
        'file.open': 'Open',
        'file.save': 'Save',
        'file.lua_filter': 'Lua Script (*.lua)',
        'file.all_files': 'All Files (*.*)',
        # Scripting
        'scripting.title': 'Scripting',
        'scripting.run': 'Run',
        'scripting.stop': 'Stop',
        'scripting.load': 'Load Script',
        'scripting.save': 'Save Script',
        'scripting.run_selection': 'Run Selection',
        'scripting.run_file': 'Run File',
        'scripting.clear': 'Clear Output',
        'scripting.lua_missing': "Lua runtime not available. Install 'lupa' (pip install lupa) to enable scripting.",
        'scripting.running': 'Script running...',
        'scripting.completed': 'Script finished.',
        'scripting.stopped': 'Stop requested.',
        'scripting.load_error': 'Failed to load script',
        # PUP info
        'pup.invalid_path': 'Invalid path. File not found.',
        'pup.valid': '✓ Valid firmware',
        'pup.suspicious': '✗ Suspicious firmware: {reasons}',
        'pup.read_fail': 'Failed to read PUP information',
        # Toolbar
        'toolbar.title': 'Console/Virtualization',
        'toolbar.memory': 'Memory',
        # Status
        'status.loading_modules': 'Loading modules...',
        'status.load_modules_error': 'Failed to load modules',
        # Memory info dialog
        'memory.title': 'Memory',
        'memory.info': 'PS3 memory management\nRAM: 256MB XDR\nVRAM: 256MB GDDR3',
        # Modules loader logs
        'modules.loaded': 'Loaded: {path}',
        'modules.entrypoint_missing': "Entrypoint {entry} missing in {dll}",
        'modules.initialize_returned': 'Initialize returned: {ok}',
        'modules.load_failed': 'Failed to load {path}: {error}',
        'modules.build_dirs_missing': 'Build directories not found. Build the DLLs first.',
        'modules.bundle_open_fail': 'Failed to open bundle: {error}',
        'modules.bundle_invalid_header': 'Invalid bundle (smaller than header)',
        'modules.bundle_magic_invalid': "Invalid GSCore magic (expected 'GSCR')",
        'modules.bundle_table_read_error': 'Error reading entries table: {error}',
        'modules.bundle_extracted': 'Extracted: {name} ({size} bytes)',
        'modules.bundle_extract_fail': 'Failed to extract {name}: {error}',
        'modules.recovery.prepared': '[Recovery] Virtual USB prepared at: {path}',
        'modules.recovery.copied': '[Recovery] PUP copied to: {dest}',
        'modules.recovery.prepare_fail': '[Recovery] Failed to prepare virtual USB: {error}',
        'modules.recovery.calling': 'Calling GSCX_RecoveryEntry...',
        'modules.recovery.finished': 'Recovery finished.',
        'modules.recovery.missing_entry': 'GSCX_RecoveryEntry missing in recovery module.',
        'modules.unloaded': 'Unloaded: {name}',
    },
    'es': {
        'general.language': 'Idioma',
        'general.save': 'Guardar configuración',
        'general.warning': 'Advertencia',
        'general.error': 'Error',
        'general.info': 'Información',
        'setup.title': 'Configuración de la consola PS3',
        'model.group': 'Modelo de la consola',
        'model.label': 'Modelo:',
        'model.placeholder': 'p. ej., CECHA01, CECH-2001A, CECH-4001B',
        'model.validate': 'Validar',
        'model.hint': 'Ingrese un modelo para validar',
        'gpu.group': 'Configuración de GPU (RSX)',
        'gpu.auto': 'Asignación automática',
        'gpu.manual': 'Asignación manual',
        'gpu.label': 'GPU:',
        'disc.group': 'Lector de discos',
        'disc.use_physical': 'Usar lector de disco físico',
        'usb.group': 'USB virtual (CFW/OFW)',
        'usb.firmware_label': 'Firmware (.PUP):',
        'usb.firmware_placeholder': 'Seleccione el archivo de firmware',
        'usb.browse': 'Examinar',
        'usb.none_selected': 'Ningún firmware seleccionado',
        'usb.folder_label': 'Carpeta de USB virtual (opcional):',
        'usb.folder_tooltip': 'Si se informa, el PUP se copiará como PS3UPDAT.PUP dentro de esta carpeta.',
        'usb.open_folder': 'Abrir carpeta',
        'usb.open_folder_tooltip': 'Abre la carpeta de USB virtual en el Explorador',
        'usb.dialog_title': 'USB virtual',
        'usb.no_folder': 'No hay carpeta disponible aún. Proporcione una ruta o inicie Recovery con un PUP.',
        'usb.folder_not_exists': 'La carpeta no existe: {target}',
        'usb.open_failed_title': 'Abrir carpeta',
        'usb.open_failed': 'Error al abrir la carpeta: {error}',
        'usb.open_error': 'Error: {error}',
        'storage.group': 'Almacenamiento y memoria',
        'storage.memory_label': 'Memoria del emulador (GB):',
        'storage.hdd_path_label': 'Ruta del HDD virtual:',
        'storage.hdd_path_placeholder': 'p. ej., C:/GSCX/storage/ps3_hdd.img',
        'storage.hdd_size_label': 'Tamaño del HDD (GB):',
        'storage.hdd_allocate': 'Asignar HDD',
        'storage.hdd_dialog_title': 'HDD virtual',
        'storage.hdd_need_path': 'Ingrese la ruta del archivo de HDD virtual (.img/.vhd)',
        'storage.hdd_alloc_ok': 'HDD asignado correctamente en:\n{final_path}',
        'storage.hdd_alloc_fail': 'Error al asignar HDD: {error}',
        'recovery.start': 'Iniciar modo Recovery',
        'recovery.warning_invalid_pup': 'El archivo PUP parece inválido. Arréglelo antes de continuar.',
        'recovery.error_title': 'Error',
        'recovery.error_start': 'Error al iniciar el modo Recovery: {message}',
        'file.select_firmware': 'Seleccionar firmware',
        'file.ps3_firmware_filter': 'Firmware de PS3 (*.PUP)',
        'file.open': 'Abrir',
        'file.save': 'Guardar',
        # Scripting
        'scripting.title': 'Scripting',
        'scripting.run': 'Ejecutar',
        'scripting.stop': 'Detener',
        'scripting.load': 'Cargar script',
        'scripting.save': 'Guardar script',
        'scripting.lua_missing': "Runtime de Lua no disponible. Instale 'lupa' (pip install lupa) para habilitar scripting.",
        'scripting.running': 'Script en ejecución...',
        'scripting.completed': 'Script finalizado.',
        'scripting.stopped': 'Parada solicitada.',
        'scripting.load_error': 'Error al cargar el script',
        'pup.invalid_path': 'Ruta inválida. Archivo no encontrado.',
        'pup.valid': '✓ Firmware válido',
        'pup.suspicious': '✗ Firmware sospechoso: {reasons}',
        'pup.read_fail': 'Error al leer la información del PUP',
        'toolbar.title': 'Consola/Virtualización',
        'toolbar.memory': 'Memoria',
        'status.loading_modules': 'Cargando módulos...',
        'status.load_modules_error': 'Error al cargar módulos',
        'memory.title': 'Memoria',
        'memory.info': 'Gestión de memoria de PS3\nRAM: 256MB XDR\nVRAM: 256MB GDDR3',
        'modules.loaded': 'Cargado: {path}',
        'modules.entrypoint_missing': 'Falta el entrypoint {entry} en {dll}',
        'modules.initialize_returned': 'Initialize devolvió: {ok}',
        'modules.load_failed': 'Error al cargar {path}: {error}',
        'modules.build_dirs_missing': 'No se encontraron directorios de build. Compile las DLLs primero.',
        'modules.bundle_open_fail': 'Error al abrir bundle: {error}',
        'modules.bundle_invalid_header': 'Bundle inválido (menor que el encabezado)',
        'modules.bundle_magic_invalid': "Magic de GSCore inválido (se esperaba 'GSCR')",
        'modules.bundle_table_read_error': 'Error al leer la tabla de entradas: {error}',
        'modules.bundle_extracted': 'Extraído: {name} ({size} bytes)',
        'modules.bundle_extract_fail': 'Error al extraer {name}: {error}',
        'modules.recovery.prepared': '[Recovery] USB virtual preparado en: {path}',
        'modules.recovery.copied': '[Recovery] PUP copiado a: {dest}',
        'modules.recovery.prepare_fail': '[Recovery] Error al preparar USB virtual: {error}',
        'modules.recovery.calling': 'Llamando a GSCX_RecoveryEntry...',
        'modules.recovery.finished': 'Recovery finalizado.',
        'modules.recovery.missing_entry': 'Falta GSCX_RecoveryEntry en el módulo de recovery.',
        'modules.unloaded': 'Descargado: {name}',
    },
    'pt': {
        'general.language': 'Idioma',
        'general.save': 'Salvar Configuração',
        'general.warning': 'Aviso',
        'general.error': 'Erro',
        'general.info': 'Informação',
        'setup.title': 'Configuração do Console PS3',
        'model.group': 'Modelo do Console',
        'model.label': 'Modelo:',
        'model.placeholder': 'Ex.: CECHA01, CECH-2001A, CECH-4001B',
        'model.validate': 'Validar',
        'model.hint': 'Digite um modelo para validar',
        'gpu.group': 'Configuração da GPU (RSX)',
        'gpu.auto': 'Atribuição automática',
        'gpu.manual': 'Atribuição manual',
        'gpu.label': 'GPU:',
        'disc.group': 'Leitor de Disco',
        'disc.use_physical': 'Usar leitor de disco físico',
        'usb.group': 'Pendrive Virtual (CFW/OFW)',
        'usb.firmware_label': 'Firmware (.PUP):',
        'usb.firmware_placeholder': 'Selecione o arquivo de firmware',
        'usb.browse': 'Procurar',
        'usb.none_selected': 'Nenhum firmware selecionado',
        'usb.folder_label': 'Pasta do pendrive virtual (opcional):',
        'usb.folder_tooltip': 'Se informado, o PUP será copiado como PS3UPDAT.PUP dentro desta pasta.',
        'usb.open_folder': 'Abrir Pasta',
        'usb.open_folder_tooltip': 'Abre a pasta do pendrive virtual no Explorer',
        'usb.dialog_title': 'Pendrive Virtual',
        'usb.no_folder': 'Nenhuma pasta disponível ainda. Informe um caminho ou inicie o Recovery com um PUP.',
        'usb.folder_not_exists': 'Pasta inexistente: {target}',
        'usb.open_failed_title': 'Abrir Pasta',
        'usb.open_failed': 'Falha ao abrir pasta: {error}',
        'usb.open_error': 'Erro: {error}',
        'storage.group': 'Armazenamento e Memória',
        'storage.memory_label': 'Memória do Emulador (GB):',
        'storage.hdd_path_label': 'Caminho do HDD virtual:',
        'storage.hdd_path_placeholder': 'Ex.: C:/GSCX/storage/ps3_hdd.img',
        'storage.hdd_size_label': 'Tamanho do HDD (GB):',
        'storage.hdd_allocate': 'Alocar HDD',
        'storage.hdd_dialog_title': 'HDD Virtual',
        'storage.hdd_need_path': 'Informe o caminho do arquivo do HDD virtual (.img/.vhd)',
        'storage.hdd_alloc_ok': 'HDD alocado com sucesso em:\n{final_path}',
        'storage.hdd_alloc_fail': 'Falha ao alocar HDD: {error}',
        'recovery.start': 'Iniciar Recovery Mode',
        'recovery.warning_invalid_pup': 'O arquivo PUP parece inválido. Corrija antes de continuar.',
        'recovery.error_title': 'Erro',
        'recovery.error_start': 'Erro ao iniciar Recovery Mode: {message}',
        'file.select_firmware': 'Selecionar firmware',
        'file.ps3_firmware_filter': 'Firmware PS3 (*.PUP)',
        'file.open': 'Abrir',
        'file.save': 'Salvar',
        # Scripting
        'scripting.title': 'Scripting',
        'scripting.run': 'Executar',
        'scripting.stop': 'Parar',
        'scripting.load': 'Carregar Script',
        'scripting.save': 'Salvar Script',
        'scripting.lua_missing': "Runtime Lua não disponível. Instale 'lupa' (pip install lupa) para habilitar o scripting.",
        'scripting.running': 'Script em execução...',
        'scripting.completed': 'Script finalizado.',
        'scripting.stopped': 'Parada solicitada.',
        'scripting.load_error': 'Falha ao carregar script',
        'pup.invalid_path': 'Caminho inválido. Arquivo não encontrado.',
        'pup.valid': '✓ Firmware válido',
        'pup.suspicious': '✗ Firmware suspeito: {reasons}',
        'pup.read_fail': 'Falha ao ler informações do PUP',
        'toolbar.title': 'Console/Virtualização',
        'toolbar.memory': 'Memória',
        'status.loading_modules': 'Carregando módulos...',
        'status.load_modules_error': 'Erro ao carregar módulos',
        'memory.title': 'Memória',
        'memory.info': 'Gerenciamento de memória do PS3\nRAM: 256MB XDR\nVRAM: 256MB GDDR3',
        'modules.loaded': 'Carregado: {path}',
        'modules.entrypoint_missing': 'Entrypoint {entry} ausente em {dll}',
        'modules.initialize_returned': 'Initialize retornou: {ok}',
        'modules.load_failed': 'Falha ao carregar {path}: {error}',
        'modules.build_dirs_missing': 'Diretórios de build não encontrados. Compile as DLLs primeiro.',
        'modules.bundle_open_fail': 'Falha ao abrir bundle: {error}',
        'modules.bundle_invalid_header': 'Bundle inválido (tamanho menor que cabeçalho)',
        'modules.bundle_magic_invalid': "Magic inválido no GSCore (esperado 'GSCR')",
        'modules.bundle_table_read_error': 'Erro lendo tabela de entradas: {error}',
        'modules.bundle_extracted': 'Extraído: {name} ({size} bytes)',
        'modules.bundle_extract_fail': 'Falha ao extrair {name}: {error}',
        'modules.recovery.prepared': '[Recovery] Pendrive virtual preparado em: {path}',
        'modules.recovery.copied': '[Recovery] PUP copiado para: {dest}',
        'modules.recovery.prepare_fail': '[Recovery] Falha ao preparar pendrive virtual: {error}',
        'modules.recovery.calling': 'Chamando GSCX_RecoveryEntry...',
        'modules.recovery.finished': 'Recovery finalizado.',
        'modules.recovery.missing_entry': 'GSCX_RecoveryEntry ausente no módulo de recovery.',
        'modules.unloaded': 'Descarregado: {name}',
    }
}


def set_language(lang: str):
    global _current_lang
    if lang in _translations:
        _current_lang = lang


def get_language() -> str:
    return _current_lang


def t(key: str, **kwargs) -> str:
    lang = _current_lang
    # Fallback to English, then to key
    template = _translations.get(lang, {}).get(key) or _translations['en'].get(key) or key
    try:
        return template.format(**kwargs)
    except Exception:
        return template